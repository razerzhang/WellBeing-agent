<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流式API测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .input-group { margin-bottom: 20px; }
        input[type="text"] { width: 70%; padding: 10px; margin-right: 10px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .output { background: #f8f9fa; padding: 20px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        .status { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>流式API测试</h1>
        
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="输入您的问题，例如：我想改善睡眠质量" value="我想改善睡眠质量">
            <button onclick="testStreaming()">测试流式API</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <h3>API响应：</h3>
        <div id="output" class="output"></div>
    </div>

    <script>
        async function testStreaming() {
            const messageInput = document.getElementById('messageInput');
            const output = document.getElementById('output');
            const status = document.getElementById('status');
            
            const message = messageInput.value.trim();
            if (!message) {
                showStatus('请输入消息', 'error');
                return;
            }
            
            showStatus('正在连接流式API...', 'success');
            output.textContent = '';
            
            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                showStatus('连接成功，开始接收流式数据...', 'success');
                
                const reader = response.body?.getReader();
                if (!reader) {
                    throw new Error('无法获取响应流');
                }

                let fullContent = '';
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                console.log('Received:', data);
                                
                                // 显示接收到的数据
                                const timestamp = new Date().toLocaleTimeString();
                                output.textContent += `[${timestamp}] ${JSON.stringify(data, null, 2)}\n\n`;
                                
                                // 处理不同类型的消息
                                if (data.type === 'start') {
                                    showStatus('开始生成建议...', 'success');
                                } else if (data.type === 'step') {
                                    showStatus(`步骤: ${data.message}`, 'success');
                                } else if (data.type === 'content') {
                                    const content = data.content || data.message || '';
                                    fullContent += content;
                                    showStatus(`正在生成内容... (${fullContent.length} 字符)`, 'success');
                                } else if (data.type === 'follow_up') {
                                    showStatus('生成后续问题...', 'success');
                                } else if (data.type === 'summary') {
                                    showStatus('建议生成完成！', 'success');
                                } else if (data.type === 'end') {
                                    showStatus('流式传输结束', 'success');
                                } else if (data.type === 'error') {
                                    showStatus(`错误: ${data.message}`, 'error');
                                }
                                
                            } catch (parseError) {
                                console.warn('解析失败:', parseError, '原始数据:', line);
                                output.textContent += `[解析失败] ${line}\n\n`;
                            }
                        }
                    }
                }
                
                showStatus('测试完成！', 'success');
                
            } catch (error) {
                console.error('测试失败:', error);
                showStatus(`测试失败: ${error.message}`, 'error');
                output.textContent += `[错误] ${error.message}\n\n`;
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        // 页面加载完成后自动测试
        window.addEventListener('load', () => {
            setTimeout(() => {
                testStreaming();
            }, 1000);
        });
    </script>
</body>
</html>
